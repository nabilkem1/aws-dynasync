"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SchemaAlpha = void 0;
const aws_appsync_alpha_1 = require("@aws-cdk/aws-appsync-alpha");
const aws_cdk_lib_1 = require("aws-cdk-lib");
/**
 * Class based on aws-appsync alpha Schema class,
 * deprecated in stable version but needed for
 * building schema in-progress
 */
class SchemaAlpha {
    constructor() {
        this.baseTypes = [];
        this.def = '';
    }
    bind(api) {
        return {
            apiId: api.apiId,
            definition: aws_cdk_lib_1.Lazy.string({
                produce: () => this.baseTypes.reduce((acc, type) => `${acc}${type._bindToGraphqlApi(api).toString()}\n`, `${this.declareSchema()}${this.def}`)
            })
        };
    }
    getDefinition(api) {
        return this.baseTypes.reduce((acc, type) => `${acc}${type._bindToGraphqlApi(api).toString()}\n`, `${this.declareSchema()}${this.def}`);
    }
    addToSchema(addition, delimiter = '') {
        this.def += `${delimiter}${addition}\n`;
    }
    addQuery(fieldName, field) {
        if (!this.query) {
            this.query = new aws_appsync_alpha_1.ObjectType('Query', { definition: {} });
            this.addType(this.query);
        }
        ;
        this.query.addField({ fieldName, field });
        return this.query;
    }
    addMutation(fieldName, field) {
        if (!this.mutation) {
            this.mutation = new aws_appsync_alpha_1.ObjectType('Mutation', { definition: {} });
            this.addType(this.mutation);
        }
        ;
        this.mutation.addField({ fieldName, field });
        return this.mutation;
    }
    addSubscription(fieldName, field) {
        var _a, _b;
        if (!this.subscription) {
            this.subscription = new aws_appsync_alpha_1.ObjectType('Subscription', { definition: {} });
            this.addType(this.subscription);
        }
        const directives = (_b = (_a = field.fieldOptions) === null || _a === void 0 ? void 0 : _a.directives) === null || _b === void 0 ? void 0 : _b.filter((directive) => directive.mutationFields);
        if (directives && directives.length > 1) {
            throw new Error(`Subscription fields must not have more than one directive. Received: ${directives.length}`);
        }
        this.subscription.addField({ fieldName, field });
        return this.subscription;
    }
    addType(type) {
        this.baseTypes.push(type);
        return type;
    }
    declareSchema() {
        if (!this.query && !this.mutation && !this.subscription) {
            return '';
        }
        const list = ['query', 'mutation', 'subscription'];
        return this.shapeAddition({
            prefix: 'schema',
            fields: list.map((key) => { var _a; return this[key] ? `${key}: ${(_a = this[key]) === null || _a === void 0 ? void 0 : _a.name}` : ''; })
                .filter((field) => field != ''),
        }) + '\n';
    }
    shapeAddition(options) {
        const typeName = () => { return options.name ? ` ${options.name}` : ''; };
        const interfaces = this.generateInterfaces(options.interfaceTypes);
        const directives = this.generateDirectives({
            directives: options.directives,
            modes: options.modes,
        });
        return options.fields.reduce((acc, field) => `${acc}  ${field}\n`, `${options.prefix}${typeName()}${interfaces}${directives} {\n`) + '}';
    }
    generateInterfaces(interfaceTypes) {
        if (!interfaceTypes || interfaceTypes.length === 0)
            return '';
        return interfaceTypes.reduce((acc, interfaceType) => `${acc} ${interfaceType.name} &`, ' implements').slice(0, -2);
    }
    generateDirectives(options) {
        if (!options.directives || options.directives.length === 0)
            return '';
        // reduce over all directives and get string version of the directive
        // pass in the auth modes for checks to happen on compile time
        return options.directives.reduce((acc, directive) => { var _a; return `${acc}${directive._bindToAuthModes(options.modes).toString()}${(_a = options.delimiter) !== null && _a !== void 0 ? _a : ' '}`; }, ' ').slice(0, -1);
    }
}
exports.SchemaAlpha = SchemaAlpha;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2NoZW1hLWFscGhhLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2FwaS9zY2hlbWEtYWxwaGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0Esa0VBTW9DO0FBQ3BDLDZDQUFtQztBQUVuQzs7OztHQUlHO0FBQ0gsTUFBYSxXQUFXO0lBQXhCO1FBQ1csY0FBUyxHQUF3QixFQUFFLENBQUM7UUFJakMsUUFBRyxHQUFVLEVBQUUsQ0FBQztJQStGOUIsQ0FBQztJQTdGRyxJQUFJLENBQUMsR0FBZTtRQUNoQixPQUFPO1lBQ0gsS0FBSyxFQUFFLEdBQUcsQ0FBQyxLQUFLO1lBQ2hCLFVBQVUsRUFBRSxrQkFBSSxDQUFDLE1BQU0sQ0FBQztnQkFDcEIsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFLENBQy9DLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFpQyxDQUFDLENBQUMsUUFBUSxFQUFFLElBQUksRUFDakYsR0FBRyxJQUFJLENBQUMsYUFBYSxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO2FBQzVDLENBQUM7U0FDTCxDQUFDO0lBQ04sQ0FBQztJQUVELGFBQWEsQ0FBQyxHQUFlO1FBQ3pCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsQ0FDbkMsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQWlDLENBQUMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxFQUNqRixHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQsV0FBVyxDQUFDLFFBQWUsRUFBRSxZQUFtQixFQUFFO1FBQzlDLElBQUksQ0FBQyxH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Q0FBQztJQUN2SCxDQUFDO0lBRU8sa0JBQWtCLENBQUMsT0FBTztRQUM5QixJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQ3RELE9BQU8sRUFBRSxDQUFDO1FBQ2QscUVBQXFFO1FBQ3JFLDhEQUE4RDtRQUM5RCxPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxFQUFFLFNBQVMsRUFBRSxFQUFFLFdBQUMsT0FBQSxHQUFHLEdBQUcsR0FBRyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsRUFBRSxHQUFHLE1BQUEsT0FBTyxDQUFDLFNBQVMsbUNBQUksR0FBRyxFQUFFLENBQUEsRUFBQSxFQUFFLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2SyxDQUFDO0NBQ0o7QUFwR0Qsa0NBb0dDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSUdyYXBocWxBcGksIElTY2hlbWFDb25maWcgfSBmcm9tIFwiYXdzLWNkay1saWIvYXdzLWFwcHN5bmNcIjtcbmltcG9ydCB7IFxuICAgIEdyYXBocWxBcGkgYXMgR3JhcGhxbEFwaUFscGhhLCBcbiAgICBGaWVsZCwgXG4gICAgSUludGVybWVkaWF0ZVR5cGUsIFxuICAgIE9iamVjdFR5cGUsIFxuICAgIFJlc29sdmFibGVGaWVsZCwgXG59IGZyb20gXCJAYXdzLWNkay9hd3MtYXBwc3luYy1hbHBoYVwiO1xuaW1wb3J0IHsgTGF6eSB9IGZyb20gXCJhd3MtY2RrLWxpYlwiO1xuXG4vKipcbiAqIENsYXNzIGJhc2VkIG9uIGF3cy1hcHBzeW5jIGFscGhhIFNjaGVtYSBjbGFzcyxcbiAqIGRlcHJlY2F0ZWQgaW4gc3RhYmxlIHZlcnNpb24gYnV0IG5lZWRlZCBmb3JcbiAqIGJ1aWxkaW5nIHNjaGVtYSBpbi1wcm9ncmVzc1xuICovXG5leHBvcnQgY2xhc3MgU2NoZW1hQWxwaGEge1xuICAgIHB1YmxpYyBiYXNlVHlwZXM6IElJbnRlcm1lZGlhdGVUeXBlW10gPSBbXTtcbiAgICBwdWJsaWMgcXVlcnk/OiBPYmplY3RUeXBlO1xuICAgIHB1YmxpYyBtdXRhdGlvbj86IE9iamVjdFR5cGU7XG4gICAgcHVibGljIHN1YnNjcmlwdGlvbj86IE9iamVjdFR5cGU7XG4gICAgcHJvdGVjdGVkIGRlZjpzdHJpbmcgPSAnJztcblxuICAgIGJpbmQoYXBpOklHcmFwaHFsQXBpKTogSVNjaGVtYUNvbmZpZyB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBhcGlJZDogYXBpLmFwaUlkLFxuICAgICAgICAgICAgZGVmaW5pdGlvbjogTGF6eS5zdHJpbmcoe1xuICAgICAgICAgICAgICAgIHByb2R1Y2U6ICgpID0+IHRoaXMuYmFzZVR5cGVzLnJlZHVjZSgoYWNjLCB0eXBlKSA9PiBcbiAgICAgICAgICAgICAgICAgICAgYCR7YWNjfSR7dHlwZS5fYmluZFRvR3JhcGhxbEFwaShhcGkgYXMgdW5rbm93biBhcyBHcmFwaHFsQXBpQWxwaGEpLnRvU3RyaW5nKCl9XFxuYCxcbiAgICAgICAgICAgICAgICAgICAgYCR7dGhpcy5kZWNsYXJlU2NoZW1hKCl9JHt0aGlzLmRlZn1gKVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBnZXREZWZpbml0aW9uKGFwaTpJR3JhcGhxbEFwaSk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLmJhc2VUeXBlcy5yZWR1Y2UoKGFjYywgdHlwZSkgPT4gXG4gICAgICAgICAgICAgICAgYCR7YWNjfSR7dHlwZS5fYmluZFRvR3JhcGhxbEFwaShhcGkgYXMgdW5rbm93biBhcyBHcmFwaHFsQXBpQWxwaGEpLnRvU3RyaW5nKCl9XFxuYCxcbiAgICAgICAgICAgICAgICBgJHt0aGlzLmRlY2xhcmVTY2hlbWEoKX0ke3RoaXMuZGVmfWApO1xuICAgIH1cblxuICAgIGFkZFRvU2NoZW1hKGFkZGl0aW9uOnN0cmluZywgZGVsaW1pdGVyOnN0cmluZyA9ICcnKSB7XG4gICAgICAgIHRoaXMuZGVmICs9IGAke2RlbGltaXRlcn0ke2FkZGl0aW9ufVxcbmA7XG4gICAgfVxuXG4gICAgYWRkUXVlcnkoZmllbGROYW1lOiBzdHJpbmcsIGZpZWxkOiBSZXNvbHZhYmxlRmllbGQpIHtcbiAgICAgICAgaWYgKCF0aGlzLnF1ZXJ5KSB7XG4gICAgICAgICAgICB0aGlzLnF1ZXJ5ID0gbmV3IE9iamVjdFR5cGUoJ1F1ZXJ5JywgeyBkZWZpbml0aW9uOiB7fSB9KTtcbiAgICAgICAgICAgIHRoaXMuYWRkVHlwZSh0aGlzLnF1ZXJ5KTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5xdWVyeS5hZGRGaWVsZCh7IGZpZWxkTmFtZSwgZmllbGQgfSk7XG4gICAgICAgIHJldHVybiB0aGlzLnF1ZXJ5O1xuICAgIH1cblxuICAgIGFkZE11dGF0aW9uKGZpZWxkTmFtZTogc3RyaW5nLCBmaWVsZDogUmVzb2x2YWJsZUZpZWxkKSB7XG4gICAgICAgIGlmICghdGhpcy5tdXRhdGlvbikge1xuICAgICAgICAgICAgdGhpcy5tdXRhdGlvbiA9IG5ldyBPYmplY3RUeXBlKCdNdXRhdGlvbicsIHsgZGVmaW5pdGlvbjoge30gfSk7XG4gICAgICAgICAgICB0aGlzLmFkZFR5cGUodGhpcy5tdXRhdGlvbik7XG4gICAgICAgIH1cbiAgICAgICAgO1xuICAgICAgICB0aGlzLm11dGF0aW9uLmFkZEZpZWxkKHsgZmllbGROYW1lLCBmaWVsZCB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMubXV0YXRpb247XG4gICAgfVxuXG4gICAgYWRkU3Vic2NyaXB0aW9uKGZpZWxkTmFtZTogc3RyaW5nLCBmaWVsZDogRmllbGQpIHtcbiAgICAgICAgaWYgKCF0aGlzLnN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgdGhpcy5zdWJzY3JpcHRpb24gPSBuZXcgT2JqZWN0VHlwZSgnU3Vic2NyaXB0aW9uJywgeyBkZWZpbml0aW9uOiB7fSB9KTtcbiAgICAgICAgICAgIHRoaXMuYWRkVHlwZSh0aGlzLnN1YnNjcmlwdGlvbik7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgZGlyZWN0aXZlcyA9IGZpZWxkLmZpZWxkT3B0aW9ucz8uZGlyZWN0aXZlcz8uZmlsdGVyKChkaXJlY3RpdmUpID0+IGRpcmVjdGl2ZS5tdXRhdGlvbkZpZWxkcyk7XG4gICAgICAgIGlmIChkaXJlY3RpdmVzICYmIGRpcmVjdGl2ZXMubGVuZ3RoID4gMSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTdWJzY3JpcHRpb24gZmllbGRzIG11c3Qgbm90IGhhdmUgbW9yZSB0aGFuIG9uZSBkaXJlY3RpdmUuIFJlY2VpdmVkOiAke2RpcmVjdGl2ZXMubGVuZ3RofWApO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZEZpZWxkKHsgZmllbGROYW1lLCBmaWVsZCB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3Vic2NyaXB0aW9uO1xuICAgIH1cblxuICAgIGFkZFR5cGUodHlwZTogSUludGVybWVkaWF0ZVR5cGUpIHtcbiAgICAgICAgdGhpcy5iYXNlVHlwZXMucHVzaCh0eXBlKTtcbiAgICAgICAgcmV0dXJuIHR5cGU7XG4gICAgfVxuICAgIFxuICAgIGRlY2xhcmVTY2hlbWEoKSB7XG4gICAgICAgIGlmICghdGhpcy5xdWVyeSAmJiAhdGhpcy5tdXRhdGlvbiAmJiAhdGhpcy5zdWJzY3JpcHRpb24pIHtcbiAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBsaXN0ID0gWydxdWVyeScsICdtdXRhdGlvbicsICdzdWJzY3JpcHRpb24nXTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2hhcGVBZGRpdGlvbih7XG4gICAgICAgICAgICBwcmVmaXg6ICdzY2hlbWEnLFxuICAgICAgICAgICAgZmllbGRzOiBsaXN0Lm1hcCgoa2V5KSA9PiB0aGlzW2tleV0gPyBgJHtrZXl9OiAke3RoaXNba2V5XT8ubmFtZX1gIDogJycpXG4gICAgICAgICAgICAgICAgLmZpbHRlcigoZmllbGQpID0+IGZpZWxkICE9ICcnKSxcbiAgICAgICAgfSkgKyAnXFxuJztcbiAgICB9XG5cbiAgICBwcml2YXRlIHNoYXBlQWRkaXRpb24ob3B0aW9ucykge1xuICAgICAgICBjb25zdCB0eXBlTmFtZSA9ICgpID0+IHsgcmV0dXJuIG9wdGlvbnMubmFtZSA/IGAgJHtvcHRpb25zLm5hbWV9YCA6ICcnOyB9O1xuICAgICAgICBjb25zdCBpbnRlcmZhY2VzID0gdGhpcy5nZW5lcmF0ZUludGVyZmFjZXMob3B0aW9ucy5pbnRlcmZhY2VUeXBlcyk7XG4gICAgICAgIGNvbnN0IGRpcmVjdGl2ZXMgPSB0aGlzLmdlbmVyYXRlRGlyZWN0aXZlcyh7XG4gICAgICAgICAgICBkaXJlY3RpdmVzOiBvcHRpb25zLmRpcmVjdGl2ZXMsXG4gICAgICAgICAgICBtb2Rlczogb3B0aW9ucy5tb2RlcyxcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBvcHRpb25zLmZpZWxkcy5yZWR1Y2UoKGFjYywgZmllbGQpID0+IGAke2FjY30gICR7ZmllbGR9XFxuYCwgYCR7b3B0aW9ucy5wcmVmaXh9JHt0eXBlTmFtZSgpfSR7aW50ZXJmYWNlc30ke2RpcmVjdGl2ZXN9IHtcXG5gKSArICd9JztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdlbmVyYXRlSW50ZXJmYWNlcyhpbnRlcmZhY2VUeXBlcykge1xuICAgICAgICBpZiAoIWludGVyZmFjZVR5cGVzIHx8IGludGVyZmFjZVR5cGVzLmxlbmd0aCA9PT0gMClcbiAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgcmV0dXJuIGludGVyZmFjZVR5cGVzLnJlZHVjZSgoYWNjLCBpbnRlcmZhY2VUeXBlKSA9PiBgJHthY2N9ICR7aW50ZXJmYWNlVHlwZS5uYW1lfSAmYCwgJyBpbXBsZW1lbnRzJykuc2xpY2UoMCwgLTIpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2VuZXJhdGVEaXJlY3RpdmVzKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKCFvcHRpb25zLmRpcmVjdGl2ZXMgfHwgb3B0aW9ucy5kaXJlY3RpdmVzLmxlbmd0aCA9PT0gMClcbiAgICAgICAgICAgIHJldHVybiAnJztcbiAgICAgICAgLy8gcmVkdWNlIG92ZXIgYWxsIGRpcmVjdGl2ZXMgYW5kIGdldCBzdHJpbmcgdmVyc2lvbiBvZiB0aGUgZGlyZWN0aXZlXG4gICAgICAgIC8vIHBhc3MgaW4gdGhlIGF1dGggbW9kZXMgZm9yIGNoZWNrcyB0byBoYXBwZW4gb24gY29tcGlsZSB0aW1lXG4gICAgICAgIHJldHVybiBvcHRpb25zLmRpcmVjdGl2ZXMucmVkdWNlKChhY2MsIGRpcmVjdGl2ZSkgPT4gYCR7YWNjfSR7ZGlyZWN0aXZlLl9iaW5kVG9BdXRoTW9kZXMob3B0aW9ucy5tb2RlcykudG9TdHJpbmcoKX0ke29wdGlvbnMuZGVsaW1pdGVyID8/ICcgJ31gLCAnICcpLnNsaWNlKDAsIC0xKTtcbiAgICB9XG59Il19