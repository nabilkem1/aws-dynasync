"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DbTable = void 0;
const aws_dynamodb_1 = require("aws-cdk-lib/aws-dynamodb");
const primary_1 = require("../key/primary");
const local_1 = require("../key/local");
const global_1 = require("../key/global");
const util_1 = require("../util");
const instance_1 = require("../key/instance");
const db_api_1 = require("./db-api");
class DbTable {
    constructor(scope, schemaTable, label) {
        this.scope = scope;
        this.schemaTable = schemaTable;
        this.label = label;
        this.baseName = this.schemaTable.tableName;
        this.tableName = this.label ? `${this.label}\.${this.schemaTable.tableName}` : this.schemaTable.tableName;
        this.props = {
            pointInTimeRecovery: true,
            ...(this.schemaTable.tableProps || {}),
        };
        this.localSecondaryIndexes = this.setLocalKeys(this.schemaTable.localSecondaryIndexes);
        this.globalSecondaryIndexes = this.setGlobalKeys(this.schemaTable.globalSecondaryIndexes);
        this.primaryKey = new primary_1.SchemaPrimaryKey(this.schemaTable.partitionKey, this.schemaTable.sortKey);
        this.attributes = this.setGraphAttributes(this.schemaTable.attributes || {});
        this.auto = this.schemaTable.auto || false;
        this.scan = this.schemaTable.scan || false;
        this.subscription = this.schemaTable.subscription || false;
        this.query = this.scan ? true : (this.schemaTable.hasOwnProperty('query') ? !!this.schemaTable.query : true);
        this.mutation = this.auto ? true : (this.schemaTable.hasOwnProperty('mutation') ? !!this.schemaTable.mutation : true);
        this.construct = new aws_dynamodb_1.Table(scope, this.tableName, {
            ...this.props,
            ...this.primaryKey.keySchema,
            tableName: this.tableName,
        });
        if (this.globalSecondaryIndexes)
            this.globalSecondaryIndexes.forEach(ind => this.construct.addGlobalSecondaryIndex(ind.props), this);
        if (this.localSecondaryIndexes)
            this.localSecondaryIndexes.forEach(ind => this.construct.addLocalSecondaryIndex(ind.props), this);
    }
    get pName() {
        return this.primaryKey.partitionKey.name;
    }
    get sName() {
        var _a;
        return (_a = this.primaryKey.sortKey) === null || _a === void 0 ? void 0 : _a.name;
    }
    addApi(api, schema) {
        this.api = new db_api_1.DbApi(this.scope, `${this.tableName}Api`, api, schema, this);
        return this.api;
    }
    setLocalKeys(keys) {
        if (!(keys === null || keys === void 0 ? void 0 : keys.length))
            return [];
        return keys.map($key => {
            if ($key instanceof local_1.SchemaLocalIndex)
                return $key;
            const key = typeof $key === 'string' ? {
                sortKey: new instance_1.KeyInstance($key, undefined, 'sort')
            } : $key;
            const name = key.indexName || `local${(0, util_1.capitalize)(this.tableName) + (0, util_1.capitalize)(typeof key.sortKey === 'string' ? key.sortKey : key.sortKey.name)}`;
            return new local_1.SchemaLocalIndex(name, key.sortKey, key.include);
        });
    }
    setGlobalKeys(keys) {
        if (!(keys === null || keys === void 0 ? void 0 : keys.length))
            return [];
        return keys.map($key => {
            if ($key instanceof global_1.SchemaGlobalIndex)
                return $key;
            const key = typeof $key === 'string' ? {
                partitionKey: new instance_1.KeyInstance($key, undefined, 'partition')
            } : $key;
            let name = '';
            if (key.indexName) {
                name = key.indexName;
            }
            else {
                const partitionKeyName = typeof key.partitionKey === 'string'
                    ? key.partitionKey
                    : key.partitionKey.name;
                const sortKeyName = key.sortKey
                    ? typeof key.sortKey === 'string'
                        ? key.sortKey
                        : key.sortKey.name
                    : '';
                name = `global${(0, util_1.capitalize)(this.tableName)}${(0, util_1.capitalize)(partitionKeyName)}${(0, util_1.capitalize)(sortKeyName)}`;
            }
            return new global_1.SchemaGlobalIndex(name, key.partitionKey, key.sortKey, key.list, key.include, key.capacity);
        });
    }
    setGraphAttributes(attrs) {
        if (typeof attrs === 'string')
            attrs = [attrs];
        let $attr = {};
        if (Array.isArray(attrs)) {
            attrs.forEach(at => {
                $attr[at] = 'string';
            });
        }
        else if (attrs && typeof attrs === 'object')
            $attr = attrs;
        return $attr;
    }
}
exports.DbTable = DbTable;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZGIvdGFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkRBS2tDO0FBU2xDLDRDQUFrRDtBQUNsRCx3Q0FBZ0Q7QUFDaEQsMENBQWtEO0FBQ2xELGtDQUFxQztBQUNyQyw4Q0FBOEM7QUFDOUMscUNBQWlDO0FBS2pDLE1BQWEsT0FBTztJQW1CaEIsWUFDVyxLQUFnQixFQUNQLFdBQXdCLEVBQ3hCLEtBQWE7UUFGdEIsVUFBSyxHQUFMLEtBQUssQ0FBVztRQUNQLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLFVBQUssR0FBTCxLQUFLLENBQVE7UUFyQnhCLGFBQVEsR0FBVSxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQztRQUM3QyxjQUFTLEdBQVksSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxLQUFLLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDO1FBR3ZILFVBQUssR0FBcUI7WUFDdEIsbUJBQW1CLEVBQUUsSUFBSTtZQUN6QixHQUFHLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDO1NBQ3pDLENBQUE7UUFDRCwwQkFBcUIsR0FBdUIsSUFBSSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLHFCQUFxQixDQUFDLENBQUE7UUFDckcsMkJBQXNCLEdBQXdCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBO1FBQ3pHLGVBQVUsR0FBRyxJQUFJLDBCQUFnQixDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0YsZUFBVSxHQUEwQixJ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QUssQ0FBQztJQUNqQixDQUFDO0NBQ0o7QUFqSEQsMEJBaUhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgXG4gICAgQmlsbGluZ01vZGUsIFxuICAgIFRhYmxlLCBcbiAgICBTdHJlYW1WaWV3VHlwZSwgXG4gICAgVGFibGVQcm9wc1xufSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZHluYW1vZGInO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgeyBcbiAgICBEeW5hbW9UYWJsZVByb3BzLCBcbiAgICBTY2hlbWFHbG9iYWwsIFxuICAgIFNjaGVtYUxvY2FsLCBcbiAgICBTY2hlbWFUYWJsZSwgXG4gICAgU2NoZW1hVGFibGVJbnN0YW5jZSBcbn0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgU2NoZW1hUHJpbWFyeUtleSB9IGZyb20gJy4uL2tleS9wcmltYXJ5JztcbmltcG9ydCB7IFNjaGVtYUxvY2FsSW5kZXggfSBmcm9tICcuLi9rZXkvbG9jYWwnO1xuaW1wb3J0IHsgU2NoZW1hR2xvYmFsSW5kZXggfSBmcm9tICcuLi9rZXkvZ2xvYmFsJztcbmltcG9ydCB7IGNhcGl0YWxpemUgfSBmcm9tICcuLi91dGlsJztcbmltcG9ydCB7IEtleUluc3RhbmNlIH0gZnJvbSAnLi4va2V5L2luc3RhbmNlJztcbmltcG9ydCB7IERiQXBpIH0gZnJvbSAnLi9kYi1hcGknO1xuaW1wb3J0IHsgR3JhcGhxbEFwaSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcHBzeW5jJztcbmltcG9ydCB7IEFwcFN5bmNTY2hlbWEgfSBmcm9tICcuLi9hcGkvc2NoZW1hJztcblxuXG5leHBvcnQgY2xhc3MgRGJUYWJsZSBpbXBsZW1lbnRzIFNjaGVtYVRhYmxlSW5zdGFuY2Uge1xuICAgIHJlYWRvbmx5IGJhc2VOYW1lOnN0cmluZyA9IHRoaXMuc2NoZW1hVGFibGUudGFibGVOYW1lO1xuICAgIHJlYWRvbmx5IHRhYmxlTmFtZTogc3RyaW5nID0gIHRoaXMubGFiZWwgPyBgJHt0aGlzLmxhYmVsfVxcLiR7dGhpcy5zY2hlbWFUYWJsZS50YWJsZU5hbWV9YCA6IHRoaXMuc2NoZW1hVGFibGUudGFibGVOYW1lO1xuICAgIGNvbnN0cnVjdDogVGFibGVcbiAgICBhcGk/OiBEYkFwaVxuICAgIHByb3BzOiBEeW5hbW9UYWJsZVByb3BzID0ge1xuICAgICAgICBwb2ludEluVGltZVJlY292ZXJ5OiB0cnVlLFxuICAgICAgICAuLi4odGhpcy5zY2hlbWFUYWJsZS50YWJsZVByb3BzIHx8IHt9KSxcbiAgICB9XG4gICAgbG9jYWxTZWNvbmRhcnlJbmRleGVzOiBTY2hlbWFMb2NhbEluZGV4W10gPSB0aGlzLnNldExvY2FsS2V5cyh0aGlzLnNjaGVtYVRhYmxlLmxvY2FsU2Vjb25kYXJ5SW5kZXhlcylcbiAgICBnbG9iYWxTZWNvbmRhcnlJbmRleGVzOiBTY2hlbWFHbG9iYWxJbmRleFtdID0gdGhpcy5zZXRHbG9iYWxLZXlzKHRoaXMuc2NoZW1hVGFibGUuZ2xvYmFsU2Vjb25kYXJ5SW5kZXhlcylcbiAgICBwcmltYXJ5S2V5ID0gbmV3IFNjaGVtYVByaW1hcnlLZXkodGhpcy5zY2hlbWFUYWJsZS5wYXJ0aXRpb25LZXksIHRoaXMuc2NoZW1hVGFibGUuc29ydEtleSk7XG4gICAgYXR0cmlidXRlczogUmVjb3JkPHN0cmluZyxzdHJpbmc+ID0gdGhpcy5zZXRHcmFwaEF0dHJpYnV0ZXModGhpcy5zY2hlbWFUYWJsZS5hdHRyaWJ1dGVzIHx8IHt9KVxuICAgIHJlYWRvbmx5IGF1dG8gPSB0aGlzLnNjaGVtYVRhYmxlLmF1dG8gfHwgZmFsc2VcbiAgICByZWFkb25seSBzY2FuID0gdGhpcy5zY2hlbWFUYWJsZS5zY2FuIHx8IGZhbHNlIFxuICAgIHJlYWRvbmx5IHN1YnNjcmlwdGlvbiA9IHRoaXMuc2NoZW1hVGFibGUuc3Vic2NyaXB0aW9uIHx8IGZhbHNlXG4gICAgcmVhZG9ubHkgcXVlcnkgPSB0aGlzLnNjYW4gPyB0cnVlIDogKHRoaXMuc2NoZW1hVGFibGUuaGFzT3duUHJvcGVydHkoJ3F1ZXJ5JykgPyAhIXRoaXMuc2NoZW1hVGFibGUucXVlcnkgOiB0cnVlKVxuICAgIHJlYWRvbmx5IG11dGF0aW9uID0gdGhpcy5hdXRvID8gdHJ1ZSA6ICh0aGlzLnNjaGVtYVRhYmxlLmhhc093blByb3BlcnR5KCdtdXRhdGlvbicpID8gISF0aGlzLnNjaGVtYVRhYmxlLm11dGF0aW9uIDogdHJ1ZSlcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHVibGljIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgICAgIHB1YmxpYyByZWFkb25seSBzY2hlbWFUYWJsZTogU2NoZW1hVGFibGUsIFxuICAgICAgICBwdWJsaWMgcmVhZG9ubHkgbGFiZWw/OnN0cmluZ1xuICAgICkge1xuXG4gICAgICAgIHRoaXMuY29uc3RydWN0ID0gbmV3IFRhYmxlKHNjb3BlLCB0aGlzLnRhYmxlTmFtZSwge1xuICAgICAgICAgICAgLi4udGhpcy5wcm9wcyxcbiAgICAgICAgICAgIC4uLnRoaXMucHJpbWFyeUtleS5rZXlTY2hlbWEsXG4gICAgICAgICAgICB0YWJsZU5hbWU6IHRoaXMudGFibGVOYW1lLFxuICAgICAgICB9KTsgXG4gICAgICAgIGlmICh0aGlzLmdsb2JhbFNlY29uZGFyeUluZGV4ZXMpXG4gICAgICAgICAgICB0aGlzLmdsb2JhbFNlY29uZGFyeUluZGV4ZXMuZm9yRWFjaChpbmQgPT4gdGhpcy5jb25zdHJ1Y3QuYWRkR2xvYmFsU2Vjb25kYXJ5SW5kZXgoaW5kLnByb3BzKSx0aGlzKTtcbiAgICAgICAgaWYgKHRoaXMubG9jYWxTZWNvbmRhcnlJbmRleGVzKVxuICAgICAgICAgICAgdGhpcy5sb2NhbFNlY29uZGFyeUluZGV4ZXMuZm9yRWFjaChpbmQgPT4gdGhpcy5jb25zdHJ1Y3QuYWRkTG9jYWxTZWNvbmRhcnlJbmRleChpbmQucHJvcHMpLHRoaXMpOyAgICAgICAgIFxuICAgIH1cblxuICAgIGdldCBwTmFtZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5wcmltYXJ5S2V5LnBhcnRpdGlvbktleS5uYW1lXG4gICAgfVxuXG4gICAgZ2V0IHNOYW1lKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnByaW1hcnlLZXkuc29ydEtleT8ubmFtZVxuICAgIH1cblxuICAgIGFkZEFwaShhcGk6R3JhcGhxbEFwaSwgc2NoZW1hOkFwcFN5bmNTY2hlbWEpOiBEYkFwaSB7XG4gICAgICAgIHRoaXMuYXBpID0gbmV3IERiQXBpKHRoaXMuc2NvcGUsIGAke3RoaXMudGFibGVOYW1lfUFwaWAsIGFwaSwgc2NoZW1hLCB0aGlzKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYXBpO1xuICAgIH1cblxuICAgICBwcm90ZWN0ZWQgc2V0TG9jYWxLZXlzKGtleXM/OiAoc3RyaW5nIHwgU2NoZW1hTG9jYWwgfCBTY2hlbWFMb2NhbEluZGV4KVtdKTogU2NoZW1hTG9jYWxJbmRleFtdIHtcbiAgICAgICAgaWYgKCFrZXlzPy5sZW5ndGgpIHJldHVybiBbXTtcbiAgICAgICAgcmV0dXJuIGtleXMubWFwKCRrZXkgPT4ge1xuICAgICAgICAgICAgaWYgKCRrZXkgaW5zdGFuY2VvZiBTY2hlbWFMb2NhbEluZGV4KSByZXR1cm4gJGtleTtcbiAgICAgICAgICAgIGNvbnN0IGtleSA9IHR5cGVvZiAka2V5ID09PSAnc3RyaW5nJyA/IHtcbiAgICAgICAgICAgICAgICBzb3J0S2V5OiBuZXcgS2V5SW5zdGFuY2UoJGtleSwgdW5kZWZpbmVkLCAnc29ydCcpXG4gICAgICAgICAgICB9IDogJGtleTtcbiAgICAgICAgICAgIGNvbnN0IG5hbWUgPSBrZXkuaW5kZXhOYW1lIHx8IGBsb2NhbCR7Y2FwaXRhbGl6ZSh0aGlzLnRhYmxlTmFtZSkgKyBjYXBpdGFsaXplKFxuICAgICAgICAgICAgICAgIHR5cGVvZiBrZXkuc29ydEtleSA9PT0gJ3N0cmluZycgPyBrZXkuc29ydEtleSA6IGtleS5zb3J0S2V5Lm5hbWVcbiAgICAgICAgICAgICl9YFxuICAgICAgICAgICAgcmV0dXJuIG5ldyBTY2hlbWFMb2NhbEluZGV4KFxuICAgICAgICAgICAgICAgICAgICBuYW1lLFxuICAgICAgICAgICAgICAgICAgICBrZXkuc29ydEtleSxcbiAgICAgICAgICAgICAgICAgICAga2V5LmluY2x1ZGVcbiAgICAgICAgICAgICk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBzZXRHbG9iYWxLZXlzKGtleXM/OiAoc3RyaW5nIHwgU2NoZW1hR2xvYmFsIHwgU2NoZW1hR2xvYmFsSW5kZXgpW10pOiBTY2hlbWFHbG9iYWxJbmRleFtdIHtcbiAgICAgICAgaWYgKCFrZXlzPy5sZW5ndGgpIHJldHVybiBbXTtcbiAgICAgICAgcmV0dXJuIGtleXMubWFwKCRrZXkgPT4ge1xuICAgICAgICAgICAgaWYgKCRrZXkgaW5zdGFuY2VvZiBTY2hlbWFHbG9iYWxJbmRleCkgcmV0dXJuICRrZXk7XG4gICAgICAgICAgICBjb25zdCBrZXkgPSB0eXBlb2YgJGtleSA9PT0gJ3N0cmluZycgPyB7XG4gICAgICAgICAgICAgICAgcGFydGl0aW9uS2V5OiBuZXcgS2V5SW5zdGFuY2UoJGtleSwgdW5kZWZpbmVkLCAncGFydGl0aW9uJylcbiAgICAgICAgICAgIH0gOiAka2V5O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBsZXQgbmFtZTogc3RyaW5nID0gJyc7XG4gICAgICAgICAgICBpZiAoa2V5LmluZGV4TmFtZSkge1xuICAgICAgICAgICAgICAgIG5hbWUgPSBrZXkuaW5kZXhOYW1lO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwYXJ0aXRpb25LZXlOYW1lID0gdHlwZW9mIGtleS5wYXJ0aXRpb25LZXkgPT09ICdzdHJpbmcnIFxuICAgICAgICAgICAgICAgICAgICAgICAgPyBrZXkucGFydGl0aW9uS2V5IFxuICAgICAgICAgICAgICAgICAgICAgICAgOiBrZXkucGFydGl0aW9uS2V5Lm5hbWU7XG5cbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc29ydEtleU5hbWUgPSBrZXkuc29ydEtleVxuICAgICAgICAgICAgICAgICAgICAgICAgPyB0eXBlb2Yga2V5LnNvcnRLZXkgPT09ICdzdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBrZXkuc29ydEtleVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDoga2V5LnNvcnRLZXkubmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgOiAnJztcblxuICAgICAgICAgICAgICAgICAgICBuYW1lID0gYGdsb2JhbCR7Y2FwaXRhbGl6ZSh0aGlzLnRhYmxlTmFtZSl9JHtjYXBpdGFsaXplKHBhcnRpdGlvbktleU5hbWUpfSR7Y2FwaXRhbGl6ZShzb3J0S2V5TmFtZSl9YDtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIG5ldyBTY2hlbWFHbG9iYWxJbmRleChcbiAgICAgICAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgICAgICAga2V5LnBhcnRpdGlvbktleSxcbiAgICAgICAgICAgICAgICAgICAga2V5LnNvcnRLZXksXG4gICAgICAgICAgICAgICAgICAgIGtleS5saXN0LFxuICAgICAgICAgICAgICAgICAgICBrZXkuaW5jbHVkZSxcbiAgICAgICAgICAgICAgICAgICAga2V5LmNhcGFjaXR5XG4gICAgICAgICAgICApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgc2V0R3JhcGhBdHRyaWJ1dGVzKGF0dHJzPzpzdHJpbmcgfCBzdHJpbmdbXSB8IFJlY29yZDxzdHJpbmcsc3RyaW5nPik6IFJlY29yZDxzdHJpbmcsc3RyaW5nPiB7XG4gICAgICAgIGlmICh0eXBlb2YgYXR0cnMgPT09ICdzdHJpbmcnKSBhdHRycyA9IFthdHRyc107XG4gICAgICAgIGxldCAkYXR0cjpSZWNvcmQ8c3RyaW5nLHN0cmluZz4gPSB7fVxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhdHRycykpIHtcbiAgICAgICAgICAgIGF0dHJzLmZvckVhY2goYXQgPT4ge1xuICAgICAgICAgICAgICAgICRhdHRyW2F0XSA9ICdzdHJpbmcnXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIGlmIChhdHRycyAmJiB0eXBlb2YgYXR0cnMgPT09ICdvYmplY3QnKSAkYXR0ciA9IGF0dHJzO1xuICAgICAgICByZXR1cm4gJGF0dHI7XG4gICAgfVxufSJdfQ==