"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DbApi = void 0;
const aws_appsync_1 = require("aws-cdk-lib/aws-appsync");
const util_1 = require("../util");
class DbApi {
    constructor(scope, id, api, schema, table) {
        var _a, _b;
        this.scope = scope;
        this.id = id;
        this.api = api;
        this.schema = schema;
        this.table = table;
        (0, util_1.validateTable)(table);
        this.dataSource = new aws_appsync_1.DynamoDbDataSource(scope, `${id}-${this.table.tableName}DataSource`, {
            api,
            name: `${this.table.tableName}DataSource`,
            table: table.construct
        });
        const usedOperations = [];
        const dataSource = this.dataSource;
        /** QUERIES */
        if (table.query) {
            if (table.scan) {
                // Get Whole Table
                this.api.createResolver(`scan${table.baseName}`, {
                    fieldName: `scan${table.baseName}`,
                    typeName: 'Query',
                    dataSource,
                    responseMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbResultList(),
                    requestMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbScanTable()
                });
            }
            let getName = `get${table.baseName}By${(0, util_1.capitalize)(table.pName)}`;
            if (table.sName)
                getName += `And${(0, util_1.capitalize)(table.sName)}`;
            if (!usedOperations.includes(getName)) {
                this.api.createResolver(getName, {
                    fieldName: getName,
                    typeName: 'Query',
                    dataSource,
                    responseMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbResultItem(),
                    requestMappingTemplate: table.sName ?
                        this.primaryTemplate(this.getPrimaryKey(table.pName, table.sName))
                        : aws_appsync_1.MappingTemplate.dynamoDbGetItem(table.pName, table.pName)
                });
                usedOperations.push(getName);
            }
            if (table.sName) {
                const partitionKeyName = `list${table.baseName}By${(0, util_1.capitalize)(table.pName)}`;
                if (!usedOperations.includes(partitionKeyName)) {
                    this.api.createResolver(partitionKeyName, {
                        fieldName: partitionKeyName,
                        typeName: 'Query',
                        dataSource,
                        responseMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbResultList(),
                        requestMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbQuery(aws_appsync_1.KeyCondition.eq(table.pName, table.pName))
                    });
                    usedOperations.push(partitionKeyName);
                }
            }
            // Loop through indexes
            if ((_a = table.globalSecondaryIndexes) === null || _a === void 0 ? void 0 : _a.length) {
                table.globalSecondaryIndexes.forEach(index => {
                    const prefix = (index.sortKey || index.list) ? 'list' : 'get';
                    const getIndexName = `${prefix}${table.baseName}By${(0, util_1.capitalize)(index.pName)}`;
                    if (!usedOperations.includes(getIndexName)) {
                        let index_name = '';
                        if (index.indexName) {
                            index_name = index.indexName;
                        }
                        else {
                            index_name = `global${table.baseName}${(0, util_1.capitalize)(index.pName)}${(0, util_1.capitalize)(index.sName || '')}`;
                        }
                        this.api.createResolver(getIndexName, {
                            fieldName: getIndexName,
                            typeName: 'Query',
                            dataSource,
                            responseMappingTemplate: (index.sortKey || index.list) ?
                                aws_appsync_1.MappingTemplate.dynamoDbResultList() :
                                aws_appsync_1.MappingTemplate.dynamoDbResultItem(),
                            requestMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbQuery(aws_appsync_1.KeyCondition.eq(index.pName, index.pName), index_name)
                        });
                        usedOperations.push(getIndexName);
                    }
                    if (index.sName) {
                        const sortName = `get${table.baseName}By${(0, util_1.capitalize)(index.pName)}And${(0, util_1.capitalize)(index.sName)}`;
                        if (!usedOperations.includes(sortName)) {
                            this.api.createResolver(sortName, {
                                fieldName: sortName,
                                typeName: 'Query',
                                dataSource,
                                responseMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbResultItem(),
                                requestMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbQuery(aws_appsync_1.KeyCondition.eq(index.pName, index.pName)
                                    .and(aws_appsync_1.KeyCondition.eq(index.sName, index.sName)), index.indexName)
                            });
                            usedOperations.push(sortName);
                        }
                    }
                });
                if ((_b = table.localSecondaryIndexes) === null || _b === void 0 ? void 0 : _b.length) {
                    table.localSecondaryIndexes.forEach(index => {
                        const localName = `get${table.baseName}By${(0, util_1.capitalize)(table.pName)}And${(0, util_1.capitalize)(index.sName)}`;
                        if (!usedOperations.includes(localName)) {
                            this.api.createResolver(localName, {
                                fieldName: localName,
                                typeName: 'Query',
                                dataSource,
                                responseMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbResultItem(),
                                requestMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbQuery(aws_appsync_1.KeyCondition.eq(table.pName, table.pName)
                                    .and(aws_appsync_1.KeyCondition.eq(index.sName, index.sName)), index.indexName)
                            });
                            usedOperations.push(localName);
                        }
                    });
                }
            }
        }
        /** MUTATIONS */
        if (table.mutation) {
            if (table.auto) {
                // Create item
                this.api.createResolver(`create${table.baseName}`, {
                    fieldName: `create${table.baseName}`,
                    typeName: 'Mutation',
                    dataSource,
                    responseMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbResultItem(),
                    requestMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbPutItem(aws_appsync_1.PrimaryKey.partition(table.pName).auto(), aws_appsync_1.Values.projecting('input')),
                });
            }
            // Put item
            this.api.createResolver(`put${table.baseName}`, {
                fieldName: `put${table.baseName}`,
                typeName: 'Mutation',
                dataSource,
                responseMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbResultItem(),
                requestMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbPutItem(this.getPrimaryKey(table.pName, table.sName), aws_appsync_1.Values.projecting('input')),
            });
            // Delete item
            this.api.createResolver(`delete${table.baseName}`, {
                fieldName: `delete${table.baseName}`,
                typeName: 'Mutation',
                dataSource,
                responseMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbResultItem(),
                requestMappingTemplate: this.primaryTemplate(this.getPrimaryKey(table.pName, table.sName), "DeleteItem"),
            });
        }
        /** SUBSCRIPTIONS */
        if (table.subscription) {
            this.api.createResolver(`on${table.baseName}Change`, {
                fieldName: `on${table.baseName}Change`,
                typeName: 'Subscription',
                dataSource,
                responseMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbResultItem(),
                requestMappingTemplate: aws_appsync_1.MappingTemplate.dynamoDbPutItem(this.getPrimaryKey(table.pName, table.sName), aws_appsync_1.Values.projecting('input')),
            });
        }
    }
    primaryTemplate(primaryKey, operation = "GetItem") {
        return aws_appsync_1.MappingTemplate.fromString(`{"version": "2017-02-28", "operation": "${operation}", ${primaryKey.renderTemplate()}}`);
    }
    getPrimaryKey(partition, sort, auto) {
        const sortKey = sort ? this.assign(sort, auto === "sort") : undefined;
        return new aws_appsync_1.PrimaryKey(this.assign(partition, auto === "partition"), sortKey);
    }
    assign(name, auto = false) {
        const arg = auto ? "$util.autoId()" : `$ctx.args.${name}`;
        return new aws_appsync_1.Assign(name, arg);
    }
}
exports.DbApi = DbApi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGItYXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2RiL2RiLWFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSx5REFRaUM7QUFJakMsa0NBQW9EO0FBQ3BELE1BQWEsS0FBSztJQUdkLFlBQ1csS0FBZ0IsRUFDaEIsRUFBVSxFQUNWLEdBQWUsRUFDZixNQUFxQixFQUNyQixLQUFjOztRQUpkLFVBQUssR0FBTCxLQUFLLENBQVc7UUFDaEIsT0FBRSxHQUFGLEVBQUUsQ0FBUTtRQUNWLFFBQUcsR0FBSCxHQUFHLENBQVk7UUFDZixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQ3JCLFVBQUssR0FBTCxLQUFLLENBQVM7UUFFckIsSUFBQSxvQkFBYSxFQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxnQ0FBa0IsQ0FBQyxLQUFLLEVBQzFDLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxZQUFZLEVBQUU7WUFDM0MsR0FBRztZQUNILElBQUksRUFBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxZQUFZO1lBQ3hDLEtBQUssRUFBRSxLQUFLLENBQUMsU0FBUztTQUN6QixDQUFDLENBQUM7UUFFSCxNQUFNLGNBQWMsR0FBWSxFQUFFLENBQUM7UUFDbkMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQztRQUVuQyxjQUFjO1FBQ2QsSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFO1lBQ2IsSUFBSSxLQUFLLENBQUMsSUFBSSxFQUFFO2dCQUNaLGtCQUFrQjtnQkFDbEIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxjQUFjLENBQUMsT0FBTyxLQUFLLENBQUMsUUFBUSxFQUFFLEVBQUU7b0JBQzdDLFNBQVMsRUFBRSxPQUFPLEtBQUssQ0FBQyxRQUFRLEVBQUU7b0JBQ2xDLFFBQVEsRUFBRSxPQUFPO29CQUNqQixVQUFVO29CQUNWLHVCQUF1QixF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QWEsRUFDYixJQUEyQjtRQUUzQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLElBQUksS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ3RFLE9BQU8sSUFBSSx3QkFBVSxDQUNuQixJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxJQUFJLEtBQUssV0FBVyxDQUFDLEVBQzVDLE9BQU8sQ0FDUixDQUFDO0lBQ04sQ0FBQztJQUVELE1BQU0sQ0FBQyxJQUFZLEVBQUUsT0FBZ0IsS0FBSztRQUN0QyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxhQUFhLElBQUksRUFBRSxDQUFDO1FBQzFELE9BQU8sSUFBSSxvQkFBTSxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztJQUNqQyxDQUFDO0NBQ0o7QUF6TkQsc0JBeU5DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgXG4gICAgQXNzaWduLCBcbiAgICBEeW5hbW9EYkRhdGFTb3VyY2UsIFxuICAgIEdyYXBocWxBcGksIFxuICAgIEtleUNvbmRpdGlvbiwgXG4gICAgTWFwcGluZ1RlbXBsYXRlLCBcbiAgICBQcmltYXJ5S2V5LCBcbiAgICBWYWx1ZXMgXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hcHBzeW5jJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gXCJjb25zdHJ1Y3RzXCI7XG5pbXBvcnQgeyBEYlRhYmxlIH0gZnJvbSBcIi4vdGFibGVcIjtcbmltcG9ydCB7IEFwcFN5bmNTY2hlbWEgfSBmcm9tICcuLi9hcGkvc2NoZW1hJztcbmltcG9ydCB7IGNhcGl0YWxpemUsIHZhbGlkYXRlVGFibGUgfSBmcm9tICcuLi91dGlsJztcbmV4cG9ydCBjbGFzcyBEYkFwaSB7XG4gICAgZGF0YVNvdXJjZTogRHluYW1vRGJEYXRhU291cmNlXG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHVibGljIHNjb3BlOiBDb25zdHJ1Y3QsXG4gICAgICAgIHB1YmxpYyBpZDogc3RyaW5nLFxuICAgICAgICBwdWJsaWMgYXBpOiBHcmFwaHFsQXBpLFxuICAgICAgICBwdWJsaWMgc2NoZW1hOiBBcHBTeW5jU2NoZW1hLFxuICAgICAgICBwdWJsaWMgdGFibGU6IERiVGFibGUsXG4gICAgKSB7XG4gICAgICAgIHZhbGlkYXRlVGFibGUodGFibGUpO1xuICAgICAgICB0aGlzLmRhdGFTb3VyY2UgPSBuZXcgRHluYW1vRGJEYXRhU291cmNlKHNjb3BlLCBcbiAgICAgICAgICAgIGAke2lkfS0ke3RoaXMudGFibGUudGFibGVOYW1lfURhdGFTb3VyY2VgLCB7XG4gICAgICAgICAgICBhcGksIFxuICAgICAgICAgICAgbmFtZTpgJHt0aGlzLnRhYmxlLnRhYmxlTmFtZX1EYXRhU291cmNlYCxcbiAgICAgICAgICAgIHRhYmxlOiB0YWJsZS5jb25zdHJ1Y3RcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgdXNlZE9wZXJhdGlvbnM6c3RyaW5nW10gPSBbXTtcbiAgICAgICAgY29uc3QgZGF0YVNvdXJjZSA9IHRoaXMuZGF0YVNvdXJjZTtcblxuICAgICAgICAvKiogUVVFUklFUyAqL1xuICAgICAgICBpZiAodGFibGUucXVlcnkpIHtcbiAgICAgICAgICAgIGlmICh0YWJsZS5zY2FuKSB7XG4gICAgICAgICAgICAgICAgLy8gR2V0IFdob2xlIFRhYmxlXG4gICAgICAgICAgICAgICAgdGhpcy5hcGkuY3JlYXRlUmVzb2x2ZXIoYHNjYW4ke3RhYmxlLmJhc2VOYW1lfWAsIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGROYW1lOiBgc2NhbiR7dGFibGUuYmFzZU5hbWV9YCxcbiAgICAgICAgICAgICAgICAgICAgdHlwZU5hbWU6ICdRdWVyeScsXG4gICAgICAgICAgICAgICAgICAgIGRhdGFTb3VyY2UsXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJSZXN1bHRMaXN0KCksXG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3RNYXBwaW5nVGVtcGxhdGU6IE1hcHBpbmdUZW1wbGF0ZS5keW5hbW9EYlNjYW5UYWJsZSgpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGxldCBnZXROYW1lID0gYGdldCR7dGFibGUuYmFzZU5hbWV9Qnkke2NhcGl0YWxpemUodGFibGUucE5hbWUpfWA7XG4gICAgICAgICAgICBpZiAodGFibGUuc05hbWUpIGdldE5hbWUgKz0gYEFuZCR7Y2FwaXRhbGl6ZSh0YWJsZS5zTmFtZSl9YDtcbiAgICAgICAgICAgIGlmICghdXNlZE9wZXJhdGlvbnMuaW5jbHVkZXMoZ2V0TmFtZSkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmFwaS5jcmVhdGVSZXNvbHZlcihnZXROYW1lLCB7XG4gICAgICAgICAgICAgICAgICAgIGZpZWxkTmFtZTogZ2V0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgdHlwZU5hbWU6ICdRdWVyeScsXG4gICAgICAgICAgICAgICAgICAgIGRhdGFTb3VyY2UsXG4gICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJSZXN1bHRJdGVtKCksXG4gICAgICAgICAgICAgICAgICAgIHJlcXVlc3RNYXBwaW5nVGVtcGxhdGU6IHRhYmxlLnNOYW1lID8gXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByaW1hcnlUZW1wbGF0ZSh0aGlzLmdldFByaW1hcnlLZXkodGFibGUucE5hbWUsIHRhYmxlLnNOYW1lKSlcbiAgICAgICAgICAgICAgICAgICAgICAgIDogTWFwcGluZ1RlbXBsYXRlLmR5bmFtb0RiR2V0SXRlbSh0YWJsZS5wTmFtZSwgdGFibGUucE5hbWUpXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdXNlZE9wZXJhdGlvbnMucHVzaChnZXROYW1lKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRhYmxlLnNOYW1lKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGFydGl0aW9uS2V5TmFtZSA9IGBsaXN0JHt0YWJsZS5iYXNlTmFtZX1CeSR7Y2FwaXRhbGl6ZSh0YWJsZS5wTmFtZSl9YDtcbiAgICAgICAgICAgICAgICBpZiAoIXVzZWRPcGVyYXRpb25zLmluY2x1ZGVzKHBhcnRpdGlvbktleU5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuYXBpLmNyZWF0ZVJlc29sdmVyKHBhcnRpdGlvbktleU5hbWUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkTmFtZTogcGFydGl0aW9uS2V5TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGVOYW1lOiAnUXVlcnknLFxuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJSZXN1bHRMaXN0KCksXG4gICAgICAgICAgICAgICAgICAgICAgICByZXF1ZXN0TWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJRdWVyeShcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBLZXlDb25kaXRpb24uZXEodGFibGUucE5hbWUsIHRhYmxlLnBOYW1lKVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICB1c2VkT3BlcmF0aW9ucy5wdXNoKHBhcnRpdGlvbktleU5hbWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gTG9vcCB0aHJvdWdoIGluZGV4ZXNcbiAgICAgICAgICAgIGlmICh0YWJsZS5nbG9iYWxTZWNvbmRhcnlJbmRleGVzPy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICB0YWJsZS5nbG9iYWxTZWNvbmRhcnlJbmRleGVzLmZvckVhY2goaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwcmVmaXggPSAoaW5kZXguc29ydEtleSB8fCBpbmRleC5saXN0KSA/ICdsaXN0JyA6ICdnZXQnO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBnZXRJbmRleE5hbWUgPSBgJHtwcmVmaXh9JHt0YWJsZS5iYXNlTmFtZX1CeSR7Y2FwaXRhbGl6ZShpbmRleC5wTmFtZSl9YFxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF1c2VkT3BlcmF0aW9ucy5pbmNsdWRlcyhnZXRJbmRleE5hbWUpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXhfbmFtZTogc3RyaW5nID0gJyc7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaW5kZXguaW5kZXhOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXhfbmFtZSA9IGluZGV4LmluZGV4TmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4X25hbWUgPSBgZ2xvYmFsJHt0YWJsZS5iYXNlTmFtZX0ke2NhcGl0YWxpemUoaW5kZXgucE5hbWUpfSR7Y2FwaXRhbGl6ZShpbmRleC5zTmFtZSB8fCAnJyl9YFxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwaS5jcmVhdGVSZXNvbHZlcihnZXRJbmRleE5hbWUsIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZE5hbWU6IGdldEluZGV4TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlTmFtZTogJ1F1ZXJ5JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhU291cmNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiAoaW5kZXguc29ydEtleSB8fCBpbmRleC5saXN0KSA/IFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJSZXN1bHRMaXN0KCkgOlxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBNYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJSZXN1bHRJdGVtKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZTogTWFwcGluZ1RlbXBsYXRlLmR5bmFtb0RiUXVlcnkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEtleUNvbmRpdGlvbi5lcShpbmRleC5wTmFtZSwgaW5kZXgucE5hbWUpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleF9uYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHVzZWRPcGVyYXRpb25zLnB1c2goZ2V0SW5kZXhOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4LnNOYW1lKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzb3J0TmFtZSA9IGBnZXQke3RhYmxlLmJhc2VOYW1lfUJ5JHtjYXBpdGFsaXplKGluZGV4LnBOYW1lKX1BbmQke2NhcGl0YWxpemUoaW5kZXguc05hbWUpfWBcbiAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXVzZWRPcGVyYXRpb25zLmluY2x1ZGVzKHNvcnROYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBpLmNyZWF0ZVJlc29sdmVyKHNvcnROYW1lLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZWxkTmFtZTpzb3J0TmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZU5hbWU6ICdRdWVyeScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFTb3VyY2UsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJSZXN1bHRJdGVtKCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcXVlc3RNYXBwaW5nVGVtcGxhdGU6IE1hcHBpbmdUZW1wbGF0ZS5keW5hbW9EYlF1ZXJ5KFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgS2V5Q29uZGl0aW9uLmVxKGluZGV4LnBOYW1lLCBpbmRleC5wTmFtZSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYW5kKEtleUNvbmRpdGlvbi5lcShpbmRleC5zTmFtZSwgaW5kZXguc05hbWUpKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LmluZGV4TmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VkT3BlcmF0aW9ucy5wdXNoKHNvcnROYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICBpZiAodGFibGUubG9jYWxTZWNvbmRhcnlJbmRleGVzPy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICAgICAgdGFibGUubG9jYWxTZWNvbmRhcnlJbmRleGVzLmZvckVhY2goaW5kZXggPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbG9jYWxOYW1lID0gYGdldCR7dGFibGUuYmFzZU5hbWV9Qnkke2NhcGl0YWxpemUodGFibGUucE5hbWUpfUFuZCR7Y2FwaXRhbGl6ZShpbmRleC5zTmFtZSl9YFxuICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdXNlZE9wZXJhdGlvbnMuaW5jbHVkZXMobG9jYWxOYW1lKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBpLmNyZWF0ZVJlc29sdmVyKGxvY2FsTmFtZSwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWVsZE5hbWU6bG9jYWxOYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlTmFtZTogJ1F1ZXJ5JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGU6IE1hcHBpbmdUZW1wbGF0ZS5keW5hbW9EYlJlc3VsdEl0ZW0oKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZTogTWFwcGluZ1RlbXBsYXRlLmR5bmFtb0RiUXVlcnkoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBLZXlDb25kaXRpb24uZXEodGFibGUucE5hbWUsIHRhYmxlLnBOYW1lKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hbmQoS2V5Q29uZGl0aW9uLmVxKGluZGV4LnNOYW1lLCBpbmRleC5zTmFtZSkpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXguaW5kZXhOYW1lXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZWRPcGVyYXRpb25zLnB1c2gobG9jYWxOYW1lKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvKiogTVVUQVRJT05TICovXG4gICAgICAgIGlmICh0YWJsZS5tdXRhdGlvbikge1xuICAgICAgICAgICAgaWYgKHRhYmxlLmF1dG8pIHtcbiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgaXRlbVxuICAgICAgICAgICAgICAgIHRoaXMuYXBpLmNyZWF0ZVJlc29sdmVyKGBjcmVhdGUke3RhYmxlLmJhc2VOYW1lfWAsIHtcbiAgICAgICAgICAgICAgICAgICAgZmllbGROYW1lOiBgY3JlYXRlJHt0YWJsZS5iYXNlTmFtZX1gLFxuICAgICAgICAgICAgICAgICAgICB0eXBlTmFtZTogJ011dGF0aW9uJyxcbiAgICAgICAgICAgICAgICAgICAgZGF0YVNvdXJjZSxcbiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGU6IE1hcHBpbmdUZW1wbGF0ZS5keW5hbW9EYlJlc3VsdEl0ZW0oKSxcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZTogTWFwcGluZ1RlbXBsYXRlLmR5bmFtb0RiUHV0SXRlbShcbiAgICAgICAgICAgICAgICAgICAgICAgIFByaW1hcnlLZXkucGFydGl0aW9uKHRhYmxlLnBOYW1lKS5hdXRvKCksXG4gICAgICAgICAgICAgICAgICAgICAgICBWYWx1ZXMucHJvamVjdGluZygnaW5wdXQnKVxuICAgICAgICAgICAgICAgICAgICApLCAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFB1dCBpdGVtXG4gICAgICAgICAgICB0aGlzLmFwaS5jcmVhdGVSZXNvbHZlcihgcHV0JHt0YWJsZS5iYXNlTmFtZX1gLCB7XG4gICAgICAgICAgICAgICAgZmllbGROYW1lOiBgcHV0JHt0YWJsZS5iYXNlTmFtZX1gLFxuICAgICAgICAgICAgICAgIHR5cGVOYW1lOiAnTXV0YXRpb24nLFxuICAgICAgICAgICAgICAgIGRhdGFTb3VyY2UsXG4gICAgICAgICAgICAgICAgcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGU6IE1hcHBpbmdUZW1wbGF0ZS5keW5hbW9EYlJlc3VsdEl0ZW0oKSxcbiAgICAgICAgICAgICAgICByZXF1ZXN0TWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJQdXRJdGVtKFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFByaW1hcnlLZXkodGFibGUucE5hbWUsIHRhYmxlLnNOYW1lKSxcbiAgICAgICAgICAgICAgICAgICAgVmFsdWVzLnByb2plY3RpbmcoJ2lucHV0JylcbiAgICAgICAgICAgICAgICApLCAgICAgICAgICAgIFxuICAgICAgICAgICAgfSkgIFxuXG4gICAgICAgICAgICAvLyBEZWxldGUgaXRlbVxuICAgICAgICAgICAgdGhpcy5hcGkuY3JlYXRlUmVzb2x2ZXIoYGRlbGV0ZSR7dGFibGUuYmFzZU5hbWV9YCwge1xuICAgICAgICAgICAgICAgIGZpZWxkTmFtZTogYGRlbGV0ZSR7dGFibGUuYmFzZU5hbWV9YCxcbiAgICAgICAgICAgICAgICB0eXBlTmFtZTogJ011dGF0aW9uJyxcbiAgICAgICAgICAgICAgICBkYXRhU291cmNlLFxuICAgICAgICAgICAgICAgIHJlc3BvbnNlTWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJSZXN1bHRJdGVtKCksXG4gICAgICAgICAgICAgICAgcmVxdWVzdE1hcHBpbmdUZW1wbGF0ZTogdGhpcy5wcmltYXJ5VGVtcGxhdGUoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZ2V0UHJpbWFyeUtleSh0YWJsZS5wTmFtZSwgdGFibGUuc05hbWUpLFxuICAgICAgICAgICAgICAgICAgICBcIkRlbGV0ZUl0ZW1cIlxuICAgICAgICAgICAgICAgICksICAgICAgICAgICAgXG4gICAgICAgICAgICB9KVxuICAgICAgICB9XG5cbiAgICAgICAgLyoqIFNVQlNDUklQVElPTlMgKi9cbiAgICAgICAgaWYgKHRhYmxlLnN1YnNjcmlwdGlvbikge1xuICAgICAgICAgICAgdGhpcy5hcGkuY3JlYXRlUmVzb2x2ZXIoYG9uJHt0YWJsZS5iYXNlTmFtZX1DaGFuZ2VgLCB7XG4gICAgICAgICAgICAgICAgZmllbGROYW1lOiBgb24ke3RhYmxlLmJhc2VOYW1lfUNoYW5nZWAsXG4gICAgICAgICAgICAgICAgdHlwZU5hbWU6ICdTdWJzY3JpcHRpb24nLFxuICAgICAgICAgICAgICAgIGRhdGFTb3VyY2UsXG4gICAgICAgICAgICAgICAgcmVzcG9uc2VNYXBwaW5nVGVtcGxhdGU6IE1hcHBpbmdUZW1wbGF0ZS5keW5hbW9EYlJlc3VsdEl0ZW0oKSxcbiAgICAgICAgICAgICAgICByZXF1ZXN0TWFwcGluZ1RlbXBsYXRlOiBNYXBwaW5nVGVtcGxhdGUuZHluYW1vRGJQdXRJdGVtKFxuICAgICAgICAgICAgICAgICAgICB0aGlzLmdldFByaW1hcnlLZXkodGFibGUucE5hbWUsIHRhYmxlLnNOYW1lKSxcbiAgICAgICAgICAgICAgICAgICAgVmFsdWVzLnByb2plY3RpbmcoJ2lucHV0JylcbiAgICAgICAgICAgICAgICApLCAgICAgICAgICAgIFxuICAgICAgICAgICAgfSkgIFxuICAgICAgICB9XG4gICAgfVxuXG5cbiAgICBwcmltYXJ5VGVtcGxhdGUocHJpbWFyeUtleTogUHJpbWFyeUtleSwgb3BlcmF0aW9uOiBzdHJpbmcgPSBcIkdldEl0ZW1cIik6IE1hcHBpbmdUZW1wbGF0ZSB7XG4gICAgICAgIHJldHVybiBNYXBwaW5nVGVtcGxhdGUuZnJvbVN0cmluZyhcbiAgICAgICAgICBge1widmVyc2lvblwiOiBcIjIwMTctMDItMjhcIiwgXCJvcGVyYXRpb25cIjogXCIke29wZXJhdGlvbn1cIiwgJHtwcmltYXJ5S2V5LnJlbmRlclRlbXBsYXRlKCl9fWBcbiAgICAgICAgKTtcbiAgICB9XG5cblxuICAgIGdldFByaW1hcnlLZXkoXG4gICAgICAgIHBhcnRpdGlvbjogc3RyaW5nLFxuICAgICAgICBzb3J0Pzogc3RyaW5nLFxuICAgICAgICBhdXRvPzogXCJwYXJ0aXRpb25cIiB8IFwic29ydFwiXG4gICAgICApOiBQcmltYXJ5S2V5IHtcbiAgICAgICAgY29uc3Qgc29ydEtleSA9IHNvcnQgPyB0aGlzLmFzc2lnbihzb3J0LCBhdXRvID09PSBcInNvcnRcIikgOiB1bmRlZmluZWQ7XG4gICAgICAgIHJldHVybiBuZXcgUHJpbWFyeUtleShcbiAgICAgICAgICB0aGlzLmFzc2lnbihwYXJ0aXRpb24sIGF1dG8gPT09IFwicGFydGl0aW9uXCIpLFxuICAgICAgICAgIHNvcnRLZXlcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBhc3NpZ24obmFtZTogc3RyaW5nLCBhdXRvOiBib29sZWFuID0gZmFsc2UpOiBBc3NpZ24ge1xuICAgICAgICBjb25zdCBhcmcgPSBhdXRvID8gXCIkdXRpbC5hdXRvSWQoKVwiIDogYCRjdHguYXJncy4ke25hbWV9YDtcbiAgICAgICAgcmV0dXJuIG5ldyBBc3NpZ24obmFtZSwgYXJnKTtcbiAgICB9XG59Il19